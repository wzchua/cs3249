<!DOCTYPE html>

<!--
  COLLABORATORS:
  
-->
<html>

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>Checkerboard</title>

<!-- Load style sheets -->
<link rel="stylesheet" type="text/css" href="mainLayout.css" />

<!-- Load any supplemental Javascript libraries here -->
<script type="text/javascript" src="external_js/jquery-1.9.0.min.js"></script>
<script type="text/javascript" src="checker.js"></script>
<script type="text/javascript" src="boardEvent.js"></script>
<script type="text/javascript" src="board.js"></script>
<script type="text/javascript" src="rules.js"></script>
<script type="text/javascript" src="dragDropController.js"></script>

<script type="text/javascript">

//This script extracts parameters from the URL
//from jquery-howto.blogspot.com

    $.extend({
        getUrlVars : function() {
            var vars = [], hash;
            var hashes = window.location.href.slice(
                    window.location.href.indexOf('?') + 1).split('&');
            for ( var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        },
        getUrlVar : function(name) {
            return $.getUrlVars()[name];
        }
    });

    var DEFAULT_BOARD_SIZE = 8;

    //data model
    var board;
    var rules;
    var whoseTurn = "black";	
    var blackCheckerList = [];
    var redCheckerList = [];
    var dragDropController = new DragDropController({height:400, width:400});

    var directionOf = function(color) {
      if (color == "black") {
        return -1;
      }
      return 1;
    }

    // Fill in this function to toggle the display for whose turn
    // The color parameter should be either "black" or "red"
    var toggleTurn = function(color) {
	   // Your code here
       if(color == "black") {
            whoseTurn = "red";
            redCheckerList.forEach(function(checker) {
                dragDropController.setAsDraggable(checker);
            });        
            blackCheckerList.forEach(function(checker) {
                dragDropController.removeAsDraggable(checker);
            });    

       } else {
            whoseTurn = "black";            
            blackCheckerList.forEach(function(checker) {
                dragDropController.setAsDraggable(checker);
            });    
            redCheckerList.forEach(function(checker) {
                dragDropController.removeAsDraggable(checker);
            });
       }
    }

    var drawBoard = function(boardSize, arrow) {
        var sizePieceSqure = 400.0/boardSize;
        c = document.getElementById("myBoard"); // ← Getting Canvas html object
        ctx = c.getContext("2d"); // ← Getting Painter
        for(var i = 0; i < boardSize; i++)
        {
            for(var j = 0; j < boardSize; j++)
            {
                if((i+j)%2 === 0)
                    ctx.fillStyle = "#FFFFFF"; // ← Setting painter’s color
                else
                    ctx.fillStyle = "#a9a9a9";
                ctx.fillRect(i*sizePieceSqure,j*sizePieceSqure,sizePieceSqure,sizePieceSqure);
            }
        }
        if(arrow != undefined) {
            var halfSize = sizePieceSqure/2;
            var from = {x: arrow.from.col * sizePieceSqure + halfSize, 
                y: arrow.from.row * sizePieceSqure + halfSize};
            var to = {x: arrow.to.col * sizePieceSqure + halfSize, 
                y: arrow.to.row * sizePieceSqure + halfSize };
            ctx.strokeStyle = "yellow";
            ctx.beginPath();
            ctx.moveTo(from.x, from.y);
            ctx.lineTo(to.x, to.y);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(to.x, to.y);
            var direction = {x: to.x - from.x, y: to.y - from.y};
            var norm = Math.sqrt(direction.x * direction.x + direction.y * direction.y);
            direction.x = direction.x/norm;
            direction.y = direction.y/norm;

            //trace back halfSize length
            var newPt = {x:to.x - direction.x * halfSize, y:to.y - direction.y * halfSize};

            //move halfSize length along its normal
            ctx.lineTo(newPt.x - direction.x * halfSize, newPt.y + direction.y * halfSize);
            ctx.lineTo(newPt.x + direction.x * halfSize, newPt.y - direction.y * halfSize);
            ctx.fillStyle = "yellow";
            ctx.fill();
            ctx.closePath();

        }

    }


    // This allows the Javascript code inside this block to only run when the page
    // has finished loading in the browser.
    $(document).ready(function() {        
        var boardSize = DEFAULT_BOARD_SIZE;
        if ($.getUrlVar('size') && $.getUrlVar('size') >= 6) {
            board = new Board($.getUrlVar('size'));
            boardSize = $.getUrlVar('size');
        } else {
            board = new Board(DEFAULT_BOARD_SIZE);
        }

        var sizePieceSqure = 400.0/boardSize;
        drawBoard(boardSize);

        var overlay = document.getElementById("overlay"); 

	    rules = new Rules(board);

     	// Your code here
        dragDropController.addEventListener('outofbounds', function(ev) {
            dragDropController.dragReset();
        });
        dragDropController.addEventListener('dragrelease', function(ev) {
            var halfSize = sizePieceSqure/2;
            var checker = ev.details.checker;
            var row = Math.floor((ev.details.newTop + halfSize) / sizePieceSqure);
            var col = Math.floor((ev.details.newLeft + halfSize) / sizePieceSqure);
            //(checker, turnDirection, playerDirection, toRow, toCol)
            var result = rules.makeMove(checker, directionOf(whoseTurn),
                directionOf(whoseTurn), row, col);
            if(!result) {
                dragDropController.dragReset();
            }
        });

        board.addEventListener('add',function (e) {
            var img = new Image();
            var color = e.details.checker.color;
            var checker = e.details.checker;
            checker.DOM = img;
            var col = e.details.col;
            var row = e.details.row;
            if(color == 'black') {
                img.src = 'graphics/black-piece.png';     
                blackCheckerList.push(checker);
            } else if (color == 'red') {
                img.src = 'graphics/red-piece.png';
                redCheckerList.push(checker);
            }
            img.width = sizePieceSqure;
            img.height = sizePieceSqure;
            img.className = 'drag pieces';
            img.style.top = row * sizePieceSqure + 'px';
            img.style.left = col * sizePieceSqure + 'px';
            overlay.appendChild(img);
    	},true);

    	board.addEventListener('move',function (e) {
    		// Your code here
            var img = e.details.checker.DOM;
            img.style.top = e.details.toRow * sizePieceSqure + 'px';
            img.style.left = e.details.toCol * sizePieceSqure + 'px';
            drawBoard(boardSize, {
                from: {row: e.details.fromRow, col: e.details.fromCol},
                to: {row: e.details.toRow, col: e.details.toCol}
            });            
            toggleTurn(whoseTurn);

    	},true);

        board.addEventListener('remove', function(e) {
        	// Your code here
            var img = e.details.checker.DOM;
            img.parentNode.removeChild(img);
        }, true);

        board.addEventListener('promote',function (e) {
    		// Your code here
            var img = e.details.checker.DOM;

            var color = e.details.checker.color;
            if(color == 'black') {
                img.src = 'graphics/black-king.png';
            } else if (color == 'red') {
                img.src = 'graphics/red-king.png';
            }

    	},true);

        
        $("#btnNewGame").click(function(evt) {
            drawBoard(boardSize);
            blackCheckerDOMList = [];
            redCheckerDOMList = [];
            board.prepareNewGame();
            blackCheckerList.forEach(function(checker) {
                dragDropController.setAsDraggable(checker);
            });
        });

        $("#btnAutoMove").click(function(evt) {
          var playerColor = whoseTurn;
          var playerDirection = directionOf(playerColor);
          var result = rules.makeRandomMove(playerColor, playerDirection);
        });

        board.prepareNewGame();
        blackCheckerList.forEach(function(checker) {
            dragDropController.setAsDraggable(checker);
        });

    });
</script>


</head>

<body>

<table id="mainTable">
    <tr>
        <td id="navigation">
          <table>
			  <tr><td>		<!-- Your code here -->			</td></tr>
              <tr><td><input id="btnNewGame" type="button" name="new" value="New Game"/></td></tr>
              <tr><td><input id="btnAutoMove" type="button" name="new" value="Auto Move"/></td></tr>

            </table>
        </td>

        <td id="content">
            <!-- Your code here -->
			<canvas id="myBoard" width="400px" height="400px"></canvas>
            <div id="overlay"></div>
        </td>
    </tr>

   </table>

</body>

</html>
